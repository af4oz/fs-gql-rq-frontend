var Z=Object.defineProperty,Y=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var R=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable;var M=(e,n,r)=>n in e?Z(e,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[n]=r,p=(e,n)=>{for(var r in n||(n={}))F.call(n,r)&&M(e,r,n[r]);if(R)for(var r of R(n))P.call(n,r)&&M(e,r,n[r]);return e},b=(e,n)=>Y(e,X(n));var O=(e,n)=>{var r={};for(var o in e)F.call(e,o)&&n.indexOf(o)<0&&(r[o]=e[o]);if(e!=null&&R)for(var o of R(e))n.indexOf(o)<0&&P.call(e,o)&&(r[o]=e[o]);return r};var T=(e,n,r)=>(M(e,typeof n!="symbol"?n+"":n,r),r);import{j as U,u as ee,L as v,R as $,B as te,o as q,a as G,b as B,r as f,c as J,d as ne,e as re,f as oe,g as se,h as I,Q as ie,i as ae,k as ce}from"./vendor.2a02a94c.js";const le=function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&o(a)}).observe(document,{childList:!0,subtree:!0});function r(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerpolicy&&(i.referrerPolicy=s.referrerpolicy),s.crossorigin==="use-credentials"?i.credentials="include":s.crossorigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=r(s);fetch(s.href,i)}};le();const ue="modulepreload",V={},de="/fs-gql-rq-frontend/",j=function(n,r){return!r||r.length===0?n():Promise.all(r.map(o=>{if(o=`${de}${o}`,o in V)return;V[o]=!0;const s=o.endsWith(".css"),i=s?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${i}`))return;const a=document.createElement("link");if(a.rel=s?"stylesheet":ue,s||(a.as="script",a.crossOrigin=""),a.href=o,document.head.appendChild(a),s)return new Promise((u,l)=>{a.addEventListener("load",u),a.addEventListener("error",l)})})).then(()=>n())};const t=U.exports.jsx,c=U.exports.jsxs,A=U.exports.Fragment,he=()=>{const{pathname:e}=ee();return c("div",{className:"pt-16 w-[75%] mx-auto text-center rounded-lg bg-light-text-amber-50",children:[c("p",{children:["There was an error in loading this page."," ",t("span",{style:{cursor:"pointer",color:"#0077FF"},onClick:()=>{window.location.reload()},children:"Reload this page"})," "]}),e!=="/"&&t(v,{to:"/",className:"hover:underline",children:"Back Home"})]})};class fe extends $.Component{constructor(){super(...arguments);T(this,"state",{error:null,errorInfo:null,hasError:!1})}static getDerivedStateFromError(n){return{hasError:!0,error:n}}componentDidCatch(n,r){this.setState({errorInfo:r})}render(){return this.state.hasError?t(he,{}):this.props.children}}const k=new te("session");function D(){return sessionStorage.getItem("jwt")}function me(e){sessionStorage.setItem("jwt-iat",e.toString())}function H(e){sessionStorage.setItem("jwt",e),me(Date.now()),k.postMessage({type:"set-jwt",payload:e})}function pe(){return sessionStorage.getItem("refreshToken")}function ge(e){sessionStorage.setItem("refreshToken",e),k.postMessage({type:"set-refreshToken",payload:e})}function Q(){localStorage.removeItem("jwt"),localStorage.removeItem("refreshToken")}const K="http://localhost:4000";class ye{constructor(n){T(this,"retryCount");T(this,"currRetryCount");this.retryCount=n,this.currRetryCount=0}isTokenValidOrUndefined(){console.log("isTokenValidOrUndefined");const n=D();if(!n)return!0;const r=q(n),o=r.exp?r.exp*1e3:Number.NEGATIVE_INFINITY,s=new Date,i=o>=s.getTime();return console.log({isValid:i,retry:this.currRetryCount}),i}async fetchToken(){var n;try{const r=q(D()||"");console.log("fetchAccessToken jwt:",r);const o=pe(),s=(n=r==null?void 0:r["https://hasura.io/jwt/claims"])==null?void 0:n["X-User-Fingerprint"],u=(await(await fetch(K,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({query:`
                  mutation RefreshJwtToken($data: RefreshTokenInput!) {
                    refreshToken(data: $data) {
                      jwt
                    }
                  }
                `,variables:{data:{refreshToken:o,fingerPrintHash:s}}})})).json()).data.refreshToken.jwt;u?H(u):Q()}catch{console.warn("Your refresh token is invalid. Try to reauthenticate."),Q()}}async refresh(){if(!this.isTokenValidOrUndefined()){if(this.currRetryCount>=this.retryCount)return;this.currRetryCount+=1,await this.fetchToken()}}reset(){this.currRetryCount=0}}function be(){const e={},n=D();return n&&(e.authorization=`Bearer ${n}`),e["content-type"]="application/json",e}const ke=new ye(1),xe=async()=>({credentials:"include",headers:p({},be())});function L(e,n){return async()=>{const o=await(await fetch(K,b(p({method:"POST"},await xe()),{body:JSON.stringify({query:e,variables:n})}))).json();if(o.errors){const{message:s,extensions:i}=o.errors[0];throw i&&i.code==="INTERNAL_SERVER_ERROR"?new Error("Something went wrong!"):new Error(s)}return o.data}}const we=`
    mutation SignUp($data: UserCreateWhereInput!) {
  signupUser(data: $data) {
    jwt
    refreshToken
  }
}
    `,Ze=e=>B(["SignUp"],n=>L(we,n)(),e),ve=`
    mutation Logout {
  logout {
    ok
  }
}
    `,_e=e=>B(["Logout"],n=>L(ve,n)(),e),Se=`
    mutation Login($email: String!, $password: String!) {
  login(data: {email: $email, password: $password}) {
    jwt
    refreshToken
  }
}
    `,Ye=e=>B(["Login"],n=>L(Se,n)(),e),Ne=`
    query GetAllUsers {
  allUsers {
    name
    id
  }
}
    `,Xe=(e,n)=>G(e===void 0?["GetAllUsers"]:["GetAllUsers",e],L(Ne,e),n),Ce=`
    query WhoAmI {
  whoami {
    id
    name
  }
}
    `,Le=(e,n)=>G(e===void 0?["WhoAmI"]:["WhoAmI",e],L(Ce,e),n),Ee="_selected_54n8c_27",Re="_backdrop_54n8c_31",Te="_menu_54n8c_1",Ie="_open_54n8c_45",Ae="_menu__children_54n8c_48";var C={"menu-item":"_menu-item_54n8c_1",selected:Ee,backdrop:Re,menu:Te,open:Ie,menu__children:Ae};const W=e=>{if(typeof e=="string")return document.querySelector(e);if(typeof e=="object"){if(e instanceof HTMLElement)return e;if(e.current)return e.current}return null},je=({focusFirst:e,onClose:n,focusAfterClosed:r,autoFocus:o,overlayModal:s=!0})=>{let i=document.getElementById("modal-root");i||(i=document.createElement("div"),i.setAttribute("id","modal-root"),document.body.appendChild(i));const a=f.exports.useRef(null);let u=e?W(e):null,l=r?W(r):null;return f.exports.useEffect(()=>{function d(y){!a.current||a.current.contains(y.target)||(n(),l&&l.focus())}function g(y){y.key==="Escape"&&(n(),l&&l.focus())}return document.body.addEventListener("keyup",g),document.body.addEventListener("click",d,{capture:!0}),()=>{document.body.removeEventListener("click",d,{capture:!0}),document.body.removeEventListener("keyup",g)}},[n,l]),f.exports.useEffect(()=>{const d=h=>typeof h.focus=="function";let g=!1;const y=h=>{if(!d(h))return!1;g=!0;try{h.focus()}catch(m){console.error(m)}return g=!1,document.activeElement===h},w=h=>{for(var m=0;m<h.childNodes.length;m++){var S=h.childNodes[m];if(y(S)||w(S))return!0}return!1},E=h=>{for(var m=h.childNodes.length-1;m>=0;m--){var S=h.childNodes[m];if(y(S)||E(S))return!0}return!1};u?u.focus():o&&a.current&&w(a.current);let _;const x=h=>{if(!g){if(!a.current){console.error("dialog not found");return}a.current.contains(h.target)?_=h.target:(w(a.current),_===document.activeElement&&E(a.current),_=document.activeElement)}};return s&&document.body.classList.add("has-dialog"),document.addEventListener("focus",x,!0),()=>{s&&document.body.classList.remove("has-dialog"),document.removeEventListener("focus",x,!0),l&&l.focus()}},[u,l,o,s]),{ref:a,modalRoot:i}},N=$.forwardRef(function(n,r){const d=n,{tag:o,href:s,selected:i,children:a}=d,u=O(d,["tag","href","selected","children"]),l=C["menu-item"]+(i?C.selected:"");return o==="a"?t(v,{to:s,children:t("a",b(p({ref:r},u),{className:l,children:a}))}):t("button",b(p({ref:r},u),{className:l,children:a}))}),Me=u=>{var l=u,{open:e,anchorEl:n,anchorOrigin:r,transformOrigin:o,onClose:s,children:i}=l,a=O(l,["open","anchorEl","anchorOrigin","transformOrigin","onClose","children"]);const[d,g]=f.exports.useState(null);console.log(n),f.exports.useEffect(()=>{n&&g(n.getBoundingClientRect())},[n]);const{ref:y,modalRoot:w}=je({onClose:s,focusAfterClosed:n,overlayModal:!1});if(!w)return null;const E=()=>{let x={};if(d)return x.top=r.vertical==="top"?`calc(${d.top}px + 10px)`:`calc(${d.bottom}px + 10px)`,r.horizontal==="left"?x.left=`calc(${d.left}px + 5px)`:x.right=`calc(100vw - ${d.right-10}px)`,x},_=c("div",{role:"presentation",className:`${C.menu} ${e?C.open:""}`,children:[t("div",{tabIndex:0}),t("div",b(p({},a),{className:`${C.menu__children} shadow-md`,ref:y,tabIndex:-1,style:d?b(p({},E()),{transformOrigin:`${o.horizontal||"0px"} ${o.vertical||"0px"}`}):null,children:i})),t("div",{tabIndex:0})]});return J.createPortal(_,w)};function Oe(e){return t("svg",b(p({width:"1em",height:"1em",viewBox:"0 0 15 15"},e),{children:t("path",{fill:"currentColor",fillRule:"evenodd",d:"M1.5 3a.5.5 0 0 0 0 1h12a.5.5 0 0 0 0-1h-12ZM1 7.5a.5.5 0 0 1 .5-.5h12a.5.5 0 0 1 0 1h-12a.5.5 0 0 1-.5-.5Zm0 4a.5.5 0 0 1 .5-.5h12a.5.5 0 0 1 0 1h-12a.5.5 0 0 1-.5-.5Z",clipRule:"evenodd"})}))}function De(e){return c("svg",b(p({width:"1em",height:"1em",viewBox:"0 0 24 24"},e),{children:[t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",children:t("animate",{attributeName:"r",begin:"0",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})}),t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",transform:"rotate(45 12 12)",children:t("animate",{attributeName:"r",begin:"0.125s",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})}),t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",transform:"rotate(90 12 12)",children:t("animate",{attributeName:"r",begin:"0.25s",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})}),t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",transform:"rotate(135 12 12)",children:t("animate",{attributeName:"r",begin:"0.375s",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})}),t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",transform:"rotate(180 12 12)",children:t("animate",{attributeName:"r",begin:"0.5s",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})}),t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",transform:"rotate(225 12 12)",children:t("animate",{attributeName:"r",begin:"0.625s",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})}),t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",transform:"rotate(270 12 12)",children:t("animate",{attributeName:"r",begin:"0.75s",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})}),t("circle",{cx:"12",cy:"2",r:"0",fill:"currentColor",transform:"rotate(315 12 12)",children:t("animate",{attributeName:"r",begin:"0.875s",calcMode:"spline",dur:"1s",keySplines:"0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8;0.2 0.2 0.4 0.8",repeatCount:"indefinite",values:"0;2;0;0"})})]}))}const Ue=({profile:e,handleLogout:n})=>{const[r,o]=f.exports.useState(void 0);return c(A,{children:[t("button",{className:"outline-offset-4 text-xl p-2",onClick:s=>o(s.currentTarget),children:t(Oe,{})}),t(Me,{anchorEl:r,anchorOrigin:{vertical:"bottom",horizontal:"right"},transformOrigin:{vertical:"top",horizontal:"right"},open:Boolean(r),onClose:()=>o(void 0),children:c(A,{children:[!e&&c(A,{children:[t(N,{tag:"a",href:"/sign-in",children:"Login"}),t(N,{tag:"a",href:"/sign-up",children:"Register"})]}),c(N,{tag:"a",href:"/sign-up",children:["Profile: ",t("strong",{children:(e==null?void 0:e.name)||"Guest"})]}),(e==null?void 0:e.name)&&t(N,{tag:"button",onClick:n,children:"Logout"}),t(N,{tag:"a",href:"/about",children:"About"})]})})]})},$e=({})=>{var i,a;const{data:e}=Le(void 0),n=ne(),r=re(),{mutate:o}=_e({onSuccess:async()=>{try{H(""),ge(""),r.clear(),sessionStorage.clear(),await k.postMessage({type:"logout"}),n("/"),ke.reset()}catch(u){console.error(u)}finally{n("/")}}}),s=()=>{o({})};return c("header",{className:"py-4 px-2 lg:px-0 flex items-center justify-between",children:[t(v,{to:"/",children:t("h1",{className:"text-2xl md:text-3xl lg:text-4xl text-black font-font-extrabold underline",children:"Auth Demo"})}),c("nav",{className:"",children:[t("div",{className:"block md:hidden",children:t(Ue,{profile:e==null?void 0:e.whoami,handleLogout:s})}),c("ul",{className:"md:flex hidden flex items-center gap-4",children:[t("li",{children:t(v,{to:"/about",className:"underline",children:"about"})}),t("li",{children:t(v,{to:"/sign-in",className:"underline",children:"sign-in"})}),t("li",{children:t(v,{to:"/sign-up",className:"underline",children:"sign-up"})}),c("li",{children:["Profile: ",t("strong",{children:((i=e==null?void 0:e.whoami)==null?void 0:i.name)||"Guest"})]}),t("li",{children:((a=e==null?void 0:e.whoami)==null?void 0:a.name)&&t("button",{onClick:s,className:"ml-4 teal-btn",children:"log out"})})]})]})]})},Be=({children:e})=>c(A,{children:[t($e,{}),t("div",{className:"min-h-[80vh] px-2 lg:px-0",children:e}),t("footer",{className:"min-h-[5rem] bg-black text-white flex justify-center items-center text-center",children:"Footer"})]}),Fe=()=>t("div",{className:"flex justify-center items-center w-[inherit] h-[inherit] min-h-[inherit]","aria-label":"loading",children:t(De,{className:"text-blue-700 text-8xl"})}),Pe=()=>c("section",{children:[t("h2",{children:t("strong",{children:"About"})}),t("br",{}),c("p",{children:["This is Authentication demo focused on refresh token functionality and same"," ",t("a",{href:"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy",className:"link",children:"origin"})," ","tab/window synchronization with"," ",t("a",{href:"https://github.com/pubkey/broadcast-channel",className:"link",children:"Broadcast channel"}),". It auto refreshes jwt token after expiry and keeps jwt tokens in sync with all other opened same"," ",t("a",{href:"https://developer.mozilla.org/en-US/docs/Web/Security/Same-origin_policy",className:"link",children:"origin"})," ","tabs/windows."]}),t("br",{}),c("ol",{className:"list-decimal list-inside",children:[t("h3",{children:t("strong",{children:"Future:"})}),c("li",{children:["keep react-query cache synced across same origin tabs/windows (just like"," ",t("a",{href:"https://react-query.tanstack.com/plugins/broadcastQueryClient#_top",className:"link",children:"react query's broadcastQueryClient"})," ",")"]})]})]}),qe=f.exports.lazy(()=>j(()=>import("./Home.9ca0f353.js"),["assets/Home.9ca0f353.js","assets/vendor.2a02a94c.js"])),Ve=f.exports.lazy(()=>j(()=>import("./SignUp.de3a5eb4.js"),["assets/SignUp.de3a5eb4.js","assets/vendor.2a02a94c.js"])),Qe=f.exports.lazy(()=>j(()=>import("./SignIn.7fae1943.js"),["assets/SignIn.7fae1943.js","assets/vendor.2a02a94c.js"])),We=({basename:e="/fs-gql-rq-frontend/"})=>t(oe,{basename:e,children:t(fe,{children:t(Be,{children:t(f.exports.Suspense,{fallback:t(Fe,{}),children:c(se,{children:[t(I,{path:"/",element:t(qe,{})}),t(I,{path:"/sign-in",element:t(Qe,{})}),t(I,{path:"/sign-up",element:t(Ve,{})}),t(I,{path:"/about",element:t(Pe,{})})]})})})})}),ze=e=>{e&&e instanceof Function&&j(()=>import("./web-vitals.64ec7304.js"),[]).then(({getCLS:n,getFID:r,getFCP:o,getLCP:s,getTTFB:i})=>{n(e),r(e),o(e),s(e),i(e)})},Ge=({queryClient:e})=>{const n=f.exports.useCallback(async r=>{switch(console.log({msg:r}),r.type){case"new-tab":k.postMessage({type:"session-data",payload:JSON.stringify(sessionStorage)});break;case"session-data":try{if(r.payload){const o=JSON.parse(r.payload);for(const s in o)sessionStorage.setItem(s,o[s]);await e.refetchQueries(["WhoAmI"])}}catch(o){console.error(o)}break;case"set-jwt":sessionStorage.setItem("jwt",r.payload),await e.refetchQueries(["WhoAmI"]);break;case"set-refreshToken":sessionStorage.setItem("refreshToken",r.payload),await e.refetchQueries(["WhoAmI"]);break;case"logout":sessionStorage.clear();break}},[e]);f.exports.useEffect(()=>(k.addEventListener("message",n),sessionStorage.length||k.postMessage({type:"new-tab"}),()=>{k.removeEventListener("message",n),k.close()}),[])},z=new ie,Je=({children:e})=>(Ge({queryClient:z}),c(ae,{client:z,children:[e,t(ce.exports.ReactQueryDevtools,{initialIsOpen:!1})]}));J.render(t($.StrictMode,{children:t(Je,{children:t(We,{})})}),document.getElementById("root"));ze();export{Fe as L,c as a,Xe as b,Ze as c,ge as d,Ye as e,t as j,H as s,ke as t,Le as u};
